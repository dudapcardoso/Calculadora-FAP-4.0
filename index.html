---
layout: null
---

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Calculadora FAP – Recalcule seu índice com precisão</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google AdSense (mantido) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2064027217812464" crossorigin="anonymous"></script>

  <!-- Tailwind apenas nesta página -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: {
          'tax-blue':'#152E3E','tax-gold':'#E2B874','tax-gray':'#EBEBEB',
          'tax-dark-gray':'#6B7280','tax-bg-light':'#F9FAFB'
        }
      } }
    }
  </script>

  <style>
    #calc-fap { background-color: #152E3E; min-height: 100vh; }
    .main-card{ background:#fff;border-radius:.75rem;box-shadow:0 10px 15px -3px rgb(0 0 0 / .1),0 4px 6px -4px rgb(0 0 0 / .1) }
    .input-field{ background:#F3F4F6;border:1px solid #D1D5DB;border-radius:.5rem;transition:all .2s;color:#152E3E }
    .input-field:focus{ border-color:#E2B874; box-shadow:0 0 0 2px rgba(226,184,116,.3); outline:none }
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
    .btn-primary{ background:#152E3E;color:#fff;border-radius:.5rem;padding:.75rem 1rem;font-weight:600;transition:filter .2s;width:100% }
    .btn-primary:hover{ filter:brightness(1.1) }
    .btn-secondary{ background:#E2B874;color:#152E3E;border-radius:.5rem;padding:.75rem 1rem;font-weight:600;transition:filter .2s;width:100% }
    .btn-secondary:hover{ filter:brightness(1.05) }
    .hidden{ display:none; }
    .blob { position:absolute; filter: blur(40px); opacity:.25; pointer-events:none; }
    .addon { position:absolute; right:.75rem; top:50%; transform:translateY(-50%); color:#6B7280; font-weight:600; }
    .addon-left { position:absolute; left:.75rem; top:50%; transform:translateY(-50%); color:#6B7280; font-weight:600; } /* % à esquerda */
    #flash{display:none} #flash.show{display:block}
  </style>
</head>
<body>

<section id="calc-fap" class="text-gray-800">
  <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">

    <!-- Cabeçalho -->
    <header class="text-center mb-6">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-white">Calculadora do FAP</h1>
      <p class="mt-2 text-lg sm:text-xl text-tax-gold">Recalcule índices e veja o impacto</p>
    </header>

    <!-- HERO orgânico -->
    <section class="relative bg-tax-blue text-white rounded-2xl p-6 sm:p-8 mb-8 shadow-lg overflow-hidden">
      <div class="blob w-40 h-40 bg-tax-gold rounded-full -top-10 -left-10 absolute"></div>
      <div class="blob w-36 h-36 bg-white rounded-full -bottom-10 -right-12 absolute"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center relative">
        <div>
          <h2 class="text-2xl sm:text-3xl font-extrabold leading-tight">Solução para Empresas e Escritórios</h2>
          <p class="mt-3 text-tax-gold">Preencha os dados e recalcule o FAP com base na metodologia oficial.</p>
          <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <a href="#calc-form" class="btn-primary sm:w-auto text-center">Gerar Relatório</a>
            <a href="https://eduardocardosop.hotmart.host/descomplicando-a-contestacao-do-fap-11-passos-para-reduzir-custos-e-corrigir-inconsistencias-01babbea-fcfd-4b31-a0b3-be2ec1c869bf"
               target="_blank" class="btn-secondary sm:w-auto text-center">eBook atualizado • R$ 149,00</a>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">Portal FAPWeb</p><p class="text-sm text-tax-gray">Conferência rápida</p></div>
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">Relatório</p><p class="text-sm text-tax-gray">Imprimir/PDF</p></div>
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">eBook técnico</p><p class="text-sm text-tax-gray">11 erros</p></div>
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">Suporte</p><p class="text-sm text-tax-gray">WhatsApp</p></div>
        </div>
      </div>
    </section>

    <div class="main-card overflow-hidden">
      <!-- Painel de Entradas -->
      <div class="p-6 sm:p-8 bg-tax-bg-light border-b border-tax-gray">
        <h2 class="text-xl font-bold text-tax-blue mb-6">1. Preencha os dados</h2>

        <!-- banner de erro -->
        <div id="flash" class="mb-4 rounded-md border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm"></div>

        <div id="calc-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="cat" class="block text-sm font-medium text-tax-dark-gray mb-1">Comunicação de Acidente de Trabalho (CAT)</label>
            <input type="number" id="cat" inputmode="numeric" placeholder="Ex.: 3" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b91" class="block text-sm font-medium text-tax-dark-gray mb-1">Auxílio por incapacidade temporária (B91)</label>
            <input type="number" id="b91" inputmode="numeric" placeholder="Ex.: 1" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b92" class="block text-sm font-medium text-tax-dark-gray mb-1">Aposentadoria por incapacidade permanente (B92)</label>
            <input type="number" id="b92" inputmode="numeric" placeholder="Ex.: 0" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b93" class="block text-sm font-medium text-tax-dark-gray mb-1">Pensão por morte (B93)</label>
            <input type="number" id="b93" inputmode="numeric" placeholder="Ex.: 0" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b94" class="block text-sm font-medium text-tax-dark-gray mb-1">Auxílio-acidente (B94)</label>
            <input type="number" id="b94" inputmode="numeric" placeholder="Ex.: 2" class="w-full p-3 input-field">
          </div>

          <!-- Massa Salarial (R$) com máscara -->
          <div class="relative">
            <label for="massaSalarial" class="block text-sm font-medium text-tax-dark-gray mb-1">Massa Salarial (R$)</label>
            <input type="text" id="massaSalarial" inputmode="decimal" placeholder="R$ 1.000.000,00"
                   class="w-full p-3 input-field"
                   oninput="maskBRLInput(this)" onblur="maskBRLInput(this)">
          </div>

          <div>
            <label for="mediaVinculos" class="block text-sm font-medium text-tax-dark-gray mb-1">Número Médio de Vínculos</label>
            <input type="text" id="mediaVinculos" inputmode="decimal" placeholder="Ex.: 250,5" class="w-full p-3 input-field">
          </div>

          <!-- Benefícios (R$) com máscara -->
          <div class="relative">
            <label for="totalBeneficios" class="block text-sm font-medium text-tax-dark-gray mb-1">Valor Total de Benefícios Pagos (R$)</label>
            <input type="text" id="totalBeneficios" inputmode="decimal" placeholder="R$ 200.000,00"
                   class="w-full p-3 input-field"
                   oninput="maskBRLInput(this)" onblur="maskBRLInput(this)">
          </div>

          <div>
            <label for="totalEstabelecimentos" class="block text-sm font-medium text-tax-dark-gray mb-1">Estabelecimentos subclasse CNAE (todos insumos)</label>
            <input type="number" id="totalEstabelecimentos" inputmode="numeric" placeholder="Ex.: 1200" class="w-full p-3 input-field">
          </div>

          <!-- Rotatividade em % (símbolo à esquerda) -->
          <div class="relative">
            <label for="taxaRotatividade" class="block text-sm font-medium text-tax-dark-gray mb-1">Taxa Média de Rotatividade (%)</label>
            <input type="text" id="taxaRotatividade" inputmode="decimal" placeholder="Ex.: 18,5"
                   class="w-full p-3 pl-10 input-field">
            <span class="addon-left">%</span>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <button id="btnCalcular" type="button" class="btn-primary" onclick="calcularIndices()">Calcular</button>
          <button id="btnLimpar"   type="button" class="btn-secondary" onclick="location.reload()">Limpar</button>
        </div>

        <div class="mt-6 bg-white rounded-lg p-4">
          <div class="result text-tax-blue text-base" id="result"></div>
        </div>
      </div>

      <!-- Painel do FAP (aparece após calcular) -->
      <div class="p-6 sm:p-8 bg-white">
        <div id="camposFap" class="hidden">
          <h2 class="text-xl font-bold text-tax-blue mb-6">2. Percentis e FAP</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
              <label for="ordemFrequencia" class="block text-sm font-medium text-tax-dark-gray mb-1">Número Ordem Frequência (k)</label>
              <input type="text" id="ordemFrequencia" inputmode="decimal" placeholder="Posição no rol (1..N)"
                     class="w-full p-3 input-field" pattern="[0-9]+([,.][0-9]+)?" oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
            </div>
            <div>
              <label for="ordemGravidade" class="block text-sm font-medium text-tax-dark-gray mb-1">Número Ordem Gravidade (k)</label>
              <input type="text" id="ordemGravidade" inputmode="decimal" placeholder="Posição no rol (1..N)"
                     class="w-full p-3 input-field" pattern="[0-9]+([,.][0-9]+)?" oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
            </div>
            <div>
              <label for="ordemCusto" class="block text-sm font-medium text-tax-dark-gray mb-1">Número Ordem Custo (k)</label>
              <input type="text" id="ordemCusto" inputmode="decimal" placeholder="Posição no rol (1..N)"
                     class="w-full p-3 input-field" pattern="[0-9]+([,.][0-9]+)?" oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button id="btnCalcularFap" type="button" class="btn-primary" onclick="calcularFap()">Calcular FAP</button>
            <button id="btnRelatorio"   type="button" class="btn-secondary" onclick="abrirFormularioRelatorio()">Gerar Relatório do Cálculo</button>
          </div>

          <div class="bg-tax-bg-light rounded-lg p-4">
            <div class="result text-tax-blue text-base" id="resultFap"></div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-8 text-sm text-gray-400">
      <p>Simulador desenvolvido para fins de estimativa. Os valores podem variar.</p>
    </footer>

    <a href="https://wa.me/5548996836949" target="_blank"
       class="fixed bottom-5 right-5 bg-green-500 text-white rounded-full px-4 py-3 font-semibold shadow-lg z-50">
      💬 Fale com um especialista
    </a>

    <div class="mt-8 p-6 bg-blue-50 rounded-xl text-center shadow-sm">
      <h3 class="text-xl font-bold text-tax-blue mb-2">🔍 Quer ir além?</h3>
      <p class="text-base mb-4">💡 Compre o <strong>eBook completo por R$ 149,00</strong> e descubra 11 erros comuns que podem estar majorando seu FAP indevidamente.</p>
      <a href="https://eduardocardosop.hotmart.host/descomplicando-a-contestacao-do-fap-11-passos-para-reduzir-custos-e-corrigir-inconsistencias-01babbea-fcfd-4b31-a0b3-be2ec1c869bf"
         target="_blank" class="inline-block btn-secondary w-auto">👉 Adquirir eBook</a>
    </div>

  </div>
</section>

<script type="text/javascript">
  /* ===== Helpers ===== */
  var flashEl = document.getElementById('flash');
  function flash(msg){
    if(!flashEl){ alert(msg); return; }
    flashEl.innerHTML = msg;
    flashEl.className = "mb-4 rounded-md border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm show";
    setTimeout(function(){ flashEl.className = "mb-4 rounded-md border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm"; }, 6000);
  }

  function br4(n){ return isFinite(n) ? Number(n).toFixed(4).replace('.', ',') : '—'; }
  function br2(n){ return isFinite(n) ? Number(n).toFixed(2).replace('.', ',') : '—'; }
  function brCurrency(n){ return isFinite(n) ? Number(n).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '—'; }

  // Máscara BRL em tempo real
  function maskBRLInput(el){
    var raw = (el.value || '').toString().replace(/\D/g,''); // só dígitos
    if(raw.length === 0){ el.value = ''; return; }
    var cents = parseInt(raw,10);
    if(!isFinite(cents)){ el.value=''; return; }
    var val = (cents / 100);
    el.value = 'R$ ' + val.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  // Converte "R$ 1.234,56" -> 1234.56
  function parseBRLForCalc(str){
    if(str === null || str === undefined) return NaN;
    var s = String(str).trim();
    if(!s) return NaN;
    return parseFloat(s.replace(/[R$\s]/g,'').replace(/\./g,'').replace(',', '.'));
  }

  // Converte números com vírgula (ex.: "18,5")
  function parseGeneric(str){
    if(str === null || str === undefined) return NaN;
    var s = String(str).trim();
    if(!s) return NaN;
    return parseFloat(s.replace(/\./g,'').replace(',', '.'));
  }

  function verificarCamposObrigatorios(ids) {
    for (var i=0;i<ids.length;i++){
      var id = ids[i];
      var el = document.getElementById(id);
      if (!el || !String(el.value).trim()) {
        flash('Por favor, preencha o campo: <strong>' + id.replace(/([A-Z])/g, ' $1').trim() + '</strong>');
        return false;
      }
    }
    return true;
  }

  /* ===== Cálculo 1: Índices (por mil) ===== */
  function calcularIndices() {
    try{
      var obrig = ["cat","b91","b92","b93","b94","massaSalarial","mediaVinculos","totalBeneficios"];
      if (!verificarCamposObrigatorios(obrig)) return;

      var cat = parseGeneric(document.getElementById("cat").value) || 0;
      var b91 = parseGeneric(document.getElementById("b91").value) || 0;
      var b92 = parseGeneric(document.getElementById("b92").value) || 0;
      var b93 = parseGeneric(document.getElementById("b93").value) || 0;
      var b94 = parseGeneric(document.getElementById("b94").value) || 0;

      var massaSalarial   = parseBRLForCalc(document.getElementById("massaSalarial").value);
      var mediaVinculos   = parseGeneric(document.getElementById("mediaVinculos").value);
      var totalBeneficios = parseBRLForCalc(document.getElementById("totalBeneficios").value);

      if (!isFinite(massaSalarial) || massaSalarial <= 0){ flash("Massa Salarial deve ser maior que zero."); return; }
      if (!isFinite(mediaVinculos) || mediaVinculos <= 0){ flash("Número Médio de Vínculos deve ser maior que zero."); return; }

      var MULT = 1000;
      var somaEventos   = (b91 + b92 + b93 + b94 + cat);
      var somaGravidade = (b91*0.1 + b92*0.3 + b93*0.5 + b94*0.1 + cat*0.5);

      var indiceFrequencia = (somaEventos / mediaVinculos) * MULT;
      var indiceGravidade  = (somaGravidade / mediaVinculos) * MULT;
      var indiceCusto      = (totalBeneficios / massaSalarial) * MULT;

      var html = ''
        + '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">'
        +   '<div><p class="text-sm text-tax-dark-gray">Índice de Frequência</p><p class="text-2xl font-bold text-tax-blue">' + (isFinite(indiceFrequencia)?indiceFrequencia.toFixed(4):'—') + '</p>'
        +       '<p class="text-xs text-tax-dark-gray mt-1">Checagem: ('+somaEventos+' / '+mediaVinculos+') × 1000</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">Índice de Gravidade</p><p class="text-2xl font-bold text-tax-blue">' + (isFinite(indiceGravidade)?indiceGravidade.toFixed(4):'—') + '</p>'
        +       '<p class="text-xs text-tax-dark-gray mt-1">Checagem: ('+somaGravidade.toFixed(4)+' / '+mediaVinculos+') × 1000</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">Índice de Custo</p><p class="text-2xl font-bold text-tax-blue">' + (isFinite(indiceCusto)?indiceCusto.toFixed(4):'—') + '</p>'
        +       '<p class="text-xs text-tax-dark-gray mt-1">Checagem: ('+totalBeneficios+' / '+massaSalarial+') × 1000</p></div>'
        + '</div>';
      document.getElementById("result").innerHTML = html;

      document.getElementById("camposFap").classList.remove('hidden');
    }catch(err){
      console.error(err); flash("Erro ao calcular os índices. Revise os campos e tente novamente.");
    }
  }

  /* ===== Cálculo 2: Percentis + FAP ===== */
  function calcularFap() {
    try{
      var obrig = ["ordemFrequencia","ordemGravidade","ordemCusto","totalEstabelecimentos","taxaRotatividade"];
      if (!verificarCamposObrigatorios(obrig)) return;

      var ordemFrequencia = parseGeneric(document.getElementById("ordemFrequencia").value) || 0;
      var ordemGravidade  = parseGeneric(document.getElementById("ordemGravidade").value) || 0;
      var ordemCusto      = parseGeneric(document.getElementById("ordemCusto").value) || 0;
      var totalEstab      = parseGeneric(document.getElementById("totalEstabelecimentos").value) || 1;
      var taxaRot         = parseGeneric(document.getElementById("taxaRotatividade").value) || 0;

      var denom = (totalEstab - 1);
      var temBasePercentil = denom > 0;

      var pFreq  = temBasePercentil ? ((ordemFrequencia - 1) / denom) * 100 : 0;
      var pGrav  = temBasePercentil ? ((ordemGravidade  - 1) / denom) * 100 : 0;
      var pCusto = temBasePercentil ? ((ordemCusto      - 1) / denom) * 100 : 0;

      var indiceComposto = ((0.5 * pGrav) + (0.35 * pFreq) + (0.15 * pCusto)) * 0.02;
      var fap = (indiceComposto <= 0.5) ? 0.5 : indiceComposto;
      if (taxaRot > 75 && fap < 1) fap = 1;

      var html = ''
        + '<div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">'
        +   '<div><p class="text-sm text-tax-dark-gray">% Frequência</p><p class="text-2xl font-bold text-tax-blue">' + br4(pFreq) + '%</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">% Gravidade</p><p class="text-2xl font-bold text-tax-blue">' + br4(pGrav) + '%</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">% Custo</p><p class="text-2xl font-bold text-tax-blue">' + br4(pCusto) + '%</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">FAP Calculado</p><p class="text-2xl font-bold text-tax-blue">' + br4(fap) + '</p></div>'
        + '</div>'
        + (temBasePercentil ? '' : '<p class="text-xs text-red-600 mt-2">Observação: N (total de estabelecimentos) ≤ 1. Percentis exibidos como 0% para evitar divisão por zero.</p>');
      document.getElementById("resultFap").innerHTML = html;
    }catch(err){
      console.error(err); flash("Erro ao calcular FAP. Revise os campos e tente novamente.");
    }
  }

  /* ===== Relatório (cartão do FAP + fórmulas com dados + explicativo) ===== */
  function abrirFormularioRelatorio() {
    try{
      var cat = parseGeneric(document.getElementById("cat").value) || 0;
      var b91 = parseGeneric(document.getElementById("b91").value) || 0;
      var b92 = parseGeneric(document.getElementById("b92").value) || 0;
      var b93 = parseGeneric(document.getElementById("b93").value) || 0;
      var b94 = parseGeneric(document.getElementById("b94").value) || 0;

      var massaSalarial   = parseBRLForCalc(document.getElementById("massaSalarial").value) || 0;
      var mediaVinculos   = parseGeneric(document.getElementById("mediaVinculos").value) || 1;
      var totalBeneficios = parseBRLForCalc(document.getElementById("totalBeneficios").value) || 0;

      var ordemFrequencia = parseGeneric(document.getElementById("ordemFrequencia").value) || 0;
      var ordemGravidade  = parseGeneric(document.getElementById("ordemGravidade").value) || 0;
      var ordemCusto      = parseGeneric(document.getElementById("ordemCusto").value) || 0;
      var totalEstab      = parseGeneric(document.getElementById("totalEstabelecimentos").value) || 1;
      var taxaRot         = parseGeneric(document.getElementById("taxaRotatividade").value) || 0;

      var MULT = 1000;
      var somaEventos   = (b91 + b92 + b93 + b94 + cat);
      var somaGravidade = (b91*0.1 + b92*0.3 + b93*0.5 + b94*0.1 + cat*0.5);

      var indiceFrequencia = (somaEventos   / mediaVinculos) * MULT;
      var indiceGravidade  = (somaGravidade / mediaVinculos) * MULT;
      var indiceCusto      = (totalBeneficios / massaSalarial) * MULT;

      var denom = (totalEstab - 1);
      var temBasePercentil = denom > 0;

      var pFreq  = temBasePercentil ? ((ordemFrequencia - 1) / denom) * 100 : 0;
      var pGrav  = temBasePercentil ? ((ordemGravidade  - 1) / denom) * 100 : 0;
      var pCusto = temBasePercentil ? ((ordemCusto      - 1) / denom) * 100 : 0;

      var indiceComposto = ((0.5 * pGrav) + (0.35 * pFreq) + (0.15 * pCusto)) * 0.02;
      var fap = (indiceComposto <= 0.5) ? 0.5 : indiceComposto;
      if (taxaRot > 75 && fap < 1) fap = 1;

      var html = ''
      + '<!doctype html><html lang="pt-BR"><head><meta charset="utf-8">'
      + '<title>Relatório do Cálculo do FAP</title><meta name="viewport" content="width=device-width, initial-scale=1">'
      + '<script src="https://cdn.tailwindcss.com"><\/script>'
      + '<script>tailwind.config={theme:{extend:{colors:{\"tax-blue\":\"#152E3E\",\"tax-gold\":\"#E2B874\",\"tax-gray\":\"#EBEBEB\",\"tax-dark-gray\":\"#6B7280\",\"tax-bg-light\":\"#F9FAFB\"}}}}<\/script>'
      + '<style>@media print{.no-print{display:none!important}body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'
      + '.card{background:#fff;border-radius:.75rem;box-shadow:0 10px 15px -3px rgb(0 0 0 / .1),0 4px 6px -4px rgb(0 0 0 / .1)}'
      + 'code{background:#F3F4F6;padding:.1rem .35rem;border-radius:.35rem}'
      + '.muted{color:#6B7280}'
      + '</style></head>'
      + '<body class="bg-tax-bg-light text-tax-blue">'
        + '<header class="bg-tax-blue text-white p-6 sm:p-8">'
          + '<div class="max-w-5xl mx-auto flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">'
            + '<div><h1 class="text-2xl sm:text-3xl font-extrabold">Relatório do Cálculo do FAP</h1><p class="text-tax-gold">www.calculadorafap.com.br</p></div>'
            + '<button class="no-print bg-white text-tax-blue font-semibold px-4 py-2 rounded-md shadow" onclick="window.print()">Imprimir / Salvar PDF</button>'
          + '</div>'
        + '</header>'

        + '<main class="max-w-5xl mx-auto p-6 sm:p-8 space-y-8">'

          + '<section class="grid grid-cols-1 sm:grid-cols-4 gap-6">' // agora com 4 cards (inclui FAP)
            + '<div class="card p-5 text-center"><p class="text-sm muted">Índice de Frequência</p><p class="text-3xl font-bold">' + br4(indiceFrequencia) + '</p>'
            + '<p class="text-xs muted mt-1">('+somaEventos+' / '+mediaVinculos+') × 1000</p></div>'
            + '<div class="card p-5 text-center"><p class="text-sm muted">Índice de Gravidade</p><p class="text-3xl font-bold">' + br4(indiceGravidade) + '</p>'
            + '<p class="text-xs muted mt-1">('+somaGravidade.toFixed(4)+' / '+mediaVinculos+') × 1000</p></div>'
            + '<div class="card p-5 text-center"><p class="text-sm muted">Índice de Custo</p><p class="text-3xl font-bold">' + br4(indiceCusto) + '</p>'
            + '<p class="text-xs muted mt-1">('+totalBeneficios+' / '+massaSalarial+') × 1000</p></div>'
            + '<div class="card p-5 text-center"><p class="text-sm muted">FAP Calculado</p><p class="text-3xl font-bold">' + br4(fap) + '</p>'
            + (taxaRot>75 && fap===1 ? '<p class="text-xs muted mt-1">ajustado por rotatividade &gt; 75%</p>' : '<p class="text-xs muted mt-1">&nbsp;</p>')
            + '</div>'
          + '</section>'

          + '<section class="card p-5">'
            + '<h2 class="text-lg font-bold mb-4">Entradas (Fatos Geradores)</h2>'
            + '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">'
              + '<table class="w-full text-sm"><tbody class="divide-y divide-tax-gray">'
                + '<tr><td class="py-2">CAT</td><td class="py-2 text-right">' + br2(cat) + '</td></tr>'
                + '<tr><td class="py-2">B91</td><td class="py-2 text-right">' + br2(b91) + '</td></tr>'
                + '<tr><td class="py-2">B92</td><td class="py-2 text-right">' + br2(b92) + '</td></tr>'
                + '<tr><td class="py-2">B93</td><td class="py-2 text-right">' + br2(b93) + '</td></tr>'
                + '<tr><td class="py-2">B94</td><td class="py-2 text-right">' + br2(b94) + '</td></tr>'
              + '</tbody></table>'
              + '<table class="w-full text-sm"><tbody class="divide-y divide-tax-gray">'
                + '<tr><td class="py-2">Massa Salarial</td><td class="py-2 text-right">' + brCurrency(massaSalarial) + '</td></tr>'
                + '<tr><td class="py-2">Média de Vínculos</td><td class="py-2 text-right">' + br4(mediaVinculos) + '</td></tr>'
                + '<tr><td class="py-2">Benefícios Pagos</td><td class="py-2 text-right">' + brCurrency(totalBeneficios) + '</td></tr>'
                + '<tr><td class="py-2">Nº Estabelecimentos (N)</td><td class="py-2 text-right">' + br2(totalEstab) + '</td></tr>'
                + '<tr><td class="py-2">Rotatividade</td><td class="py-2 text-right">' + br4(taxaRot) + '%</td></tr>'
              + '</tbody></table>'
            + '</div>'
          + '</section>'

          + '<section class="card p-5">'
            + '<h2 class="text-lg font-bold mb-2">Percentis e Índice Composto</h2>'
            + '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">'
              + '<table class="w-full text-sm mb-4"><tbody class="divide-y divide-tax-gray">'
                + '<tr><td class="py-2">% Frequência</td><td class="py-2 text-right">' + br4(pFreq) + '%</td></tr>'
                + '<tr><td class="py-2">% Gravidade</td><td class="py-2 text-right">' + br4(pGrav) + '%</td></tr>'
                + '<tr><td class="py-2">% Custo</td><td class="py-2 text-right">' + br4(pCusto) + '%</td></tr>'
              + '</tbody></table>'
              + '<table class="w-full text-sm"><tbody class="divide-y divide-tax-gray">'
                + '<tr><td class="py-2 font-semibold">Índice Composto</td><td class="py-2 text-right font-semibold">' + br4(indiceComposto) + '</td></tr>'
                + '<tr><td class="py-2 font-semibold">FAP Final</td><td class="py-2 text-right font-semibold">' + br4(fap) + (taxaRot>75 && fap===1 ? ' <span class="text-xs muted">(ajustado por rotatividade &gt; 75%)</span>' : '') + '</td></tr>'
              + '</tbody></table>'
            + '</div>'
          + '</section>'

          <!-- Explicativo curto -->
          + '<section class="card p-5">'
            + '<h2 class="text-lg font-bold mb-3">Como o FAP é calculado</h2>'
            + '<p class="text-sm leading-relaxed muted">O Fator Acidentário de Prevenção (FAP) é um multiplicador aplicado à alíquota do RAT, variando de <strong>0,5000</strong> a <strong>2,0000</strong>. '
            + 'Ele deriva de um <em>índice composto</em> que pondera os percentis de desempenho da empresa dentro da sua subclasse CNAE: '
            + '<strong>50%</strong> para Gravidade, <strong>35%</strong> para Frequência e <strong>15%</strong> para Custo. '
            + 'O índice composto é então multiplicado por <strong>0,02</strong>; se o resultado for menor que 0,5, adota-se <strong>0,5</strong> (piso). '
            + 'Se a <strong>rotatividade &gt; 75%</strong> e o FAP ficar abaixo de 1, o valor é ajustado para <strong>1,0000</strong>.</p>'
          + '</section>'

          <!-- Fórmulas: geral + com seus dados -->
          + '<section class="card p-5">'
            + '<h2 class="text-lg font-bold mb-4">Fórmulas Utilizadas</h2>'
            + '<div class="space-y-4 text-sm">'
              + '<div>'
                + '<h3 class="font-semibold mb-1">Índice de Frequência (IF)</h3>'
                + '<div class="p-3 bg-tax-bg-light rounded-lg">'
                  + '<div class="mb-1"><span class="font-semibold">Geral:</span> <code>(B91 + B92 + B93 + B94 + CAT) / MV × 1000</code></div>'
                  + '<div><span class="font-semibold">Com seus dados:</span> <code>(' + br2(b91) + ' + ' + br2(b92) + ' + ' + br2(b93) + ' + ' + br2(b94) + ' + ' + br2(cat) + ') / ' + br4(mediaVinculos) + ' × 1000 = ' + br4(indiceFrequencia) + '</code></div>'
                + '</div>'
              + '</div>'

              + '<div>'
                + '<h3 class="font-semibold mb-1">Índice de Gravidade (IG)</h3>'
                + '<div class="p-3 bg-tax-bg-light rounded-lg">'
                  + '<div class="mb-1"><span class="font-semibold">Geral:</span> <code>((B91×0,1 + B92×0,3 + B93×0,5 + B94×0,1 + CAT×0,5) / MV) × 1000</code></div>'
                  + '<div><span class="font-semibold">Com seus dados:</span> <code>((' + br2(b91) + '×0,1 + ' + br2(b92) + '×0,3 + ' + br2(b93) + '×0,5 + ' + br2(b94) + '×0,1 + ' + br2(cat) + '×0,5) / ' + br4(mediaVinculos) + ') × 1000 = ' + br4(indiceGravidade) + '</code></div>'
                + '</div>'
              + '</div>'

              + '<div>'
                + '<h3 class="font-semibold mb-1">Índice de Custo (IC)</h3>'
                + '<div class="p-3 bg-tax-bg-light rounded-lg">'
                  + '<div class="mb-1"><span class="font-semibold">Geral:</span> <code>(Benefícios / Massa Salarial) × 1000</code></div>'
                  + '<div><span class="font-semibold">Com seus dados:</span> <code>(' + brCurrency(totalBeneficios) + ' / ' + brCurrency(massaSalarial) + ') × 1000 = ' + br4(indiceCusto) + '</code></div>'
                + '</div>'
              + '</div>'

              + '<div>'
                + '<h3 class="font-semibold mb-1">Percentis</h3>'
                + '<div class="p-3 bg-tax-bg-light rounded-lg space-y-1">'
                  + '<div><code>P = ((k − 1) / (N − 1)) × 100</code></div>'
                  + '<div><code>P<sub>Freq</sub> = ((' + br4(ordemFrequencia) + ' − 1) / (' + br2(totalEstab) + ' − 1)) × 100 = ' + br4(pFreq) + '%</code></div>'
                  + '<div><code>P<sub>Grav</sub> = ((' + br4(ordemGravidade) + ' − 1) / (' + br2(totalEstab) + ' − 1)) × 100 = ' + br4(pGrav) + '%</code></div>'
                  + '<div><code>P<sub>Custo</sub> = ((' + br4(ordemCusto) + ' − 1) / (' + br2(totalEstab) + ' − 1)) × 100 = ' + br4(pCusto) + '%</code></div>'
                + '</div>'
              + '</div>'

              + '<div>'
                + '<h3 class="font-semibold mb-1">Índice Composto e FAP</h3>'
                + '<div class="p-3 bg-tax-bg-light rounded-lg space-y-1">'
                  + '<div><span class="font-semibold">Geral:</span> <code>(0,5×P<sub>Grav</sub> + 0,35×P<sub>Freq</sub> + 0,15×P<sub>Custo</sub>) × 0,02</code></div>'
                  + '<div><span class="font-semibold">Com seus dados:</span> <code>(0,5×' + br4(pGrav) + ' + 0,35×' + br4(pFreq) + ' + 0,15×' + br4(pCusto) + ') × 0,02 = ' + br4(indiceComposto) + '</code></div>'
                  + '<div><span class="font-semibold">FAP:</span> <code>max(0,5, ' + br4(indiceComposto) + ')' + (taxaRot>75 ? ' ⇒ regra de rotatividade aplicada se FAP &lt; 1' : '') + ' ⇒ ' + br4(fap) + '</code></div>'
                + '</div>'
              + '</div>'
            + '</div>'
          + '</section>'

          <p class="text-center text-xs muted">Gerado por calculadorafap.com.br</p>
        </main>'
      + '</body></html>';

      var w = window.open('', '_blank');
      w.document.open(); w.document.write(html); w.document.close();
    }catch(err){
      console.error(err); flash("Erro ao gerar o relatório.");
    }
  }

  // Expor no escopo global (garante o funcionamento do onclick)
  window.calcularIndices = calcularIndices;
  window.calcularFap = calcularFap;
  window.abrirFormularioRelatorio = abrirFormularioRelatorio;

  // Garantias extras (listeners)
  document.addEventListener('DOMContentLoaded', function(){
    var c  = document.getElementById('btnCalcular');
    var cf = document.getElementById('btnCalcularFap');
    var r  = document.getElementById('btnRelatorio');
    var l  = document.getElementById('btnLimpar');
    if(c)  c.addEventListener('click', calcularIndices);
    if(cf) cf.addEventListener('click', calcularFap);
    if(r)  r.addEventListener('click', abrirFormularioRelatorio);
    if(l)  l.addEventListener('click', function(){ location.reload(); });

    // normaliza BRL ao sair do campo
    var ms = document.getElementById('massaSalarial');
    var tb = document.getElementById('totalBeneficios');
    if(ms) ms.addEventListener('blur', function(){ maskBRLInput(ms); });
    if(tb) tb.addEventListener('blur', function(){ maskBRLInput(tb); });
  });
</script>

</body>
</html>

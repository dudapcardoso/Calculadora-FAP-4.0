---
layout: null
---

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Calculadora FAP ‚Äì Recalcule seu √≠ndice com precis√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google AdSense (mantido) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2064027217812464" crossorigin="anonymous"></script>

  <!-- Tailwind apenas nesta p√°gina -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: {
          'tax-blue':'#152E3E','tax-gold':'#E2B874','tax-gray':'#EBEBEB',
          'tax-dark-gray':'#6B7280','tax-bg-light':'#F9FAFB'
        }
      } }
    }
  </script>

  <style>
    #calc-fap { background-color: #f6f6f6; min-height: 100vh; }

    .header{ background:#152e3e; padding:1rem 0; margin-bottom:0; }
    @media(min-width:768px){ .header{ padding:2rem 0; } }
    .golden-stripe{ background:#dba958; height:6px; width:100%; }

    .top-nav a{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.45rem .75rem;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      line-height:1;
      color:rgba(255,255,255,.85);
      border:1px solid rgba(255,255,255,.15);
      transition:all .15s ease;
      white-space:nowrap;
      text-decoration:none;
      background:rgba(255,255,255,.06);
    }
    .top-nav a:hover{
      color:#fff;
      border-color:rgba(255,255,255,.35);
      transform:translateY(-1px);
      background:rgba(255,255,255,.12);
    }
    .top-nav a.is-active{
      background:#dba958;
      color:#152e3e;
      border-color:#dba958;
    }
    .top-nav-wrap{ margin-top:12px; }
    @media(max-width:767px){
      .top-nav a{ font-size:11px; padding:.4rem .6rem; }
    }

    .main-card{ background:#fff;border-radius:.75rem;box-shadow:0 10px 15px -3px rgb(0 0 0 / .1),0 4px 6px -4px rgb(0 0 0 / .1) }
    .input-field{ background:#F3F4F6;border:1px solid #D1D5DB;border-radius:.5rem;transition:all .2s;color:#152E3E }
    .input-field:focus{ border-color:#E2B874; box-shadow:0 0 0 2px rgba(226,184,116,.3); outline:none }
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
    .btn-primary{ background:#152E3E;color:#fff;border-radius:.5rem;padding:.75rem 1rem;font-weight:600;transition:filter .2s;width:100% }
    .btn-primary:hover{ filter:brightness(1.1) }
    .btn-secondary{ background:#E2B874;color:#152E3E;border-radius:.5rem;padding:.75rem 1rem;font-weight:600;transition:filter .2s;width:100% }
    .btn-secondary:hover{ filter:brightness(1.05) }
    .hidden{ display:none; }
    .blob { position:absolute; filter: blur(40px); opacity:.25; pointer-events:none; }
    .addon { position:absolute; right:.75rem; top:50%; transform:translateY(-50%); color:#6B7280; font-weight:600; }
    #flash{display:none} #flash.show{display:block}
  </style>
</head>

<body>
<section id="calc-fap" class="text-gray-800">
  <div class="header">
    <div class="container mx-auto px-6">
      <div class="flex flex-col items-center justify-between py-4 gap-3">
        <div class="title-container text-center">
          <h1 class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-extrabold text-white">
            Calculadora do FAP
          </h1>
          <p class="text-xs sm:text-sm text-gray-300 mt-1">
            Recalcule √≠ndices e veja o impacto
          </p>
        </div>

        <div class="top-nav-wrap w-full">
          <nav class="top-nav flex flex-wrap items-center justify-center gap-2">
            <a href="./index.html" class="is-active">Calculadora</a>
            <a href="./impacto-fap.html">Impactos do FAP</a>
            <a href="./como-o-fap-e-calculado.html">Como o FAP √© calculado</a>
          </nav>
        </div>
      </div>
    </div>
  </div>
  <div class="golden-stripe"></div>

  <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">

    <section class="relative bg-tax-blue text-white rounded-2xl p-6 sm:p-8 mb-8 shadow-lg overflow-hidden">
      <div class="blob w-40 h-40 bg-tax-gold rounded-full -top-10 -left-10 absolute"></div>
      <div class="blob w-36 h-36 bg-white rounded-full -bottom-10 -right-12 absolute"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center relative">
        <div>
          <h2 class="text-2xl sm:text-3xl font-extrabold leading-tight">Solu√ß√£o para Empresas e Escrit√≥rios</h2>
          <p class="mt-3 text-tax-gold">Preencha os dados e recalcule o FAP com base na metodologia oficial.</p>
          <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <a href="#calc-form" class="btn-primary sm:w-auto text-center">Gerar Relat√≥rio</a>
            <a href="https://pay.hotmart.com/H95717996W?off=b30j9ctv"
               target="_blank" class="btn-secondary sm:w-auto text-center">eBook atualizado ‚Ä¢ R$ 499,99</a>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">Portal FAPWeb</p><p class="text-sm text-tax-gray">Confer√™ncia r√°pida</p></div>
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">Relat√≥rio</p><p class="text-sm text-tax-gray">Imprimir/PDF</p></div>
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">eBook t√©cnico</p><p class="text-sm text-tax-gray">11 erros</p></div>
          <div class="bg-white/10 rounded-xl p-4"><p class="font-semibold">Suporte</p><p class="text-sm text-tax-gray">WhatsApp</p></div>
        </div>
      </div>
    </section>

    <div class="main-card overflow-hidden">
      <!-- Painel de Entradas -->
      <div class="p-6 sm:p-8 bg-tax-bg-light border-b border-tax-gray">
        <h2 class="text-xl font-bold text-tax-blue mb-6">1. Preencha os dados</h2>

        <div id="flash" class="mb-4 rounded-md border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm"></div>

        <div id="calc-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="cat" class="block text-sm font-medium text-tax-dark-gray mb-1">Comunica√ß√£o de Acidente de Trabalho (CAT)</label>
            <input type="number" id="cat" inputmode="numeric" placeholder="Ex.: 3" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b91" class="block text-sm font-medium text-tax-dark-gray mb-1">Aux√≠lio por incapacidade tempor√°ria (B91)</label>
            <input type="number" id="b91" inputmode="numeric" placeholder="Ex.: 1" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b92" class="block text-sm font-medium text-tax-dark-gray mb-1">Aposentadoria por incapacidade permanente (B92)</label>
            <input type="number" id="b92" inputmode="numeric" placeholder="Ex.: 0" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b93" class="block text-sm font-medium text-tax-dark-gray mb-1">Pens√£o por morte (B93)</label>
            <input type="number" id="b93" inputmode="numeric" placeholder="Ex.: 0" class="w-full p-3 input-field">
          </div>

          <div>
            <label for="b94" class="block text-sm font-medium text-tax-dark-gray mb-1">Aux√≠lio-acidente (B94)</label>
            <input type="number" id="b94" inputmode="numeric" placeholder="Ex.: 2" class="w-full p-3 input-field">
          </div>

          <div class="relative">
            <label for="massaSalarial" class="block text-sm font-medium text-tax-dark-gray mb-1">Massa Salarial (R$)</label>
            <input type="text" id="massaSalarial" inputmode="decimal" placeholder="R$ 1.000.000,00"
                   class="w-full p-3 input-field"
                   oninput="maskBRLInput(this)" onblur="maskBRLInput(this)">
          </div>

          <div>
            <label for="mediaVinculos" class="block text-sm font-medium text-tax-dark-gray mb-1">N√∫mero M√©dio de V√≠nculos</label>
            <input type="text" id="mediaVinculos" inputmode="decimal" placeholder="Ex.: 250,5" class="w-full p-3 input-field">
          </div>

          <div class="relative">
            <label for="totalBeneficios" class="block text-sm font-medium text-tax-dark-gray mb-1">Valor Total de Benef√≠cios Pagos (R$)</label>
            <input type="text" id="totalBeneficios" inputmode="decimal" placeholder="R$ 200.000,00"
                   class="w-full p-3 input-field"
                   oninput="maskBRLInput(this)" onblur="maskBRLInput(this)">
          </div>

          <div>
            <label for="totalEstabelecimentos" class="block text-sm font-medium text-tax-dark-gray mb-1">Estabelecimentos subclasse CNAE (todos insumos)</label>
            <input type="number" id="totalEstabelecimentos" inputmode="numeric" placeholder="Ex.: 1200" class="w-full p-3 input-field">
          </div>

          <div class="relative">
            <label for="taxaRotatividade" class="block text-sm font-medium text-tax-dark-gray mb-1">Taxa M√©dia de Rotatividade (%)</label>
            <input type="text" id="taxaRotatividade" inputmode="decimal" placeholder="Ex.: 18,5"
                   class="w-full p-3 pr-10 input-field">
            <span class="addon">%</span>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <button id="btnCalcular" type="button" class="btn-primary" onclick="calcularIndices()">Calcular</button>
          <button id="btnLimpar" type="button" class="btn-secondary" onclick="location.reload()">Limpar</button>
        </div>

        <div class="mt-6 bg-white rounded-lg p-4">
          <div class="result text-tax-blue text-base" id="result"></div>
        </div>
      </div>

      <!-- Painel do FAP -->
      <div class="p-6 sm:p-8 bg-white">
        <div id="camposFap" class="hidden">
          <h2 class="text-xl font-bold text-tax-blue mb-6">2. Percentis e FAP</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
              <label for="ordemFrequencia" class="block text-sm font-medium text-tax-dark-gray mb-1">N√∫mero Ordem Frequ√™ncia (k)</label>
              <input type="text" id="ordemFrequencia" inputmode="decimal" placeholder="Posi√ß√£o no rol (1..N)"
                     class="w-full p-3 input-field"
                     pattern="[0-9]+([,.][0-9]+)?"
                     oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
            </div>
            <div>
              <label for="ordemGravidade" class="block text-sm font-medium text-tax-dark-gray mb-1">N√∫mero Ordem Gravidade (k)</label>
              <input type="text" id="ordemGravidade" inputmode="decimal" placeholder="Posi√ß√£o no rol (1..N)"
                     class="w-full p-3 input-field"
                     pattern="[0-9]+([,.][0-9]+)?"
                     oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
            </div>
            <div>
              <label for="ordemCusto" class="block text-sm font-medium text-tax-dark-gray mb-1">N√∫mero Ordem Custo (k)</label>
              <input type="text" id="ordemCusto" inputmode="decimal" placeholder="Posi√ß√£o no rol (1..N)"
                     class="w-full p-3 input-field"
                     pattern="[0-9]+([,.][0-9]+)?"
                     oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button id="btnCalcularFap" type="button" class="btn-primary" onclick="calcularFap()">Calcular FAP</button>

            <!-- BOT√ÉO PAGO -->
            <button id="btnRelatorio" type="button" class="btn-secondary" onclick="startPaidPdfFlow()">
              Gerar Relat√≥rio do C√°lculo (R$ 9,99)
            </button>
          </div>

          <div class="bg-tax-bg-light rounded-lg p-4">
            <div class="result text-tax-blue text-base" id="resultFap"></div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-8 text-sm text-gray-400">
      <p>Simulador desenvolvido para fins de estimativa. Os valores podem variar.</p>
      <section class="max-w-3xl mx-auto mt-16 mb-10 px-6">
  <div class="bg-gray-50 border border-gray-200 rounded-2xl p-6 text-center shadow-sm">
    <h3 class="text-lg font-semibold mb-2">‚òï Gostou da ferramenta? Apoie o projeto.</h3>
    <p class="text-gray-600 text-sm mb-4">
      Se a calculadora ajudou sua empresa a identificar oportunidades ou reduzir custos,
      voc√™ pode contribuir via Pix para manter o projeto atualizado, independente e gratuito.
    </p>

    <div class="flex flex-col items-center gap-3">
      <div class="text-xs text-gray-500">
        Chave Pix:
        <span class="font-medium text-gray-800 select-all">eduardocardosop@gmail.com</span>
      </div>

      <button
        type="button"
        onclick="copyPixKey()"
        class="bg-black text-white px-6 py-2 rounded-xl text-sm hover:opacity-90 transition">
        Copiar chave Pix
      </button>

      <p id="pixCopiedMsg" class="text-xs text-gray-500 hidden">‚úÖ Chave Pix copiada!</p>
      <p class="text-xs text-gray-400">Contribui√ß√£o volunt√°ria.</p>
    </div>
  </div>
</section>

<script>
  function copyPixKey() {
    const key = "eduardocardosop@gmail.com";
    const msg = document.getElementById("pixCopiedMsg");

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(key).then(() => {
        msg.classList.remove("hidden");
        setTimeout(() => msg.classList.add("hidden"), 2500);
      }).catch(() => fallbackCopy(key, msg));
    } else {
      fallbackCopy(key, msg);
    }
  }

  function fallbackCopy(text, msgEl) {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.setAttribute("readonly", "");
    ta.style.position = "absolute";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand("copy");
      msgEl.classList.remove("hidden");
      setTimeout(() => msgEl.classList.add("hidden"), 2500);
    } catch (e) {
      // Se falhar, ao menos o texto est√° "select-all" no HTML
      alert("N√£o foi poss√≠vel copiar automaticamente. Selecione a chave Pix e copie manualmente.");
    }
    document.body.removeChild(ta);
  }
</script>
    </footer>

    <a href="https://wa.me/5548996836949" target="_blank"
       class="fixed bottom-5 right-5 bg-green-500 text-white rounded-full px-4 py-3 font-semibold shadow-lg z-50">
      üí¨ Fale com um especialista
    </a>

    <div class="mt-8 p-6 bg-blue-50 rounded-xl text-center shadow-sm">
      <h3 class="text-xl font-bold text-tax-blue mb-2">üîç Quer ir al√©m?</h3>
      <p class="text-base mb-4">üí° Compre o <strong>eBook completo por R$ 499,99</strong> e descubra 11 erros comuns que podem estar majorando seu FAP indevidamente.</p>
      <a href="https://pay.hotmart.com/H95717996W?off=b30j9ctv"
         target="_blank" class="inline-block btn-secondary w-auto">üëâ Adquirir eBook</a>
    </div>

  </div>
</section>

<script type="text/javascript">
  /* ===== Helpers ===== */
  var flashEl = document.getElementById('flash');
  function flash(msg){
    if(!flashEl){ alert(msg); return; }
    flashEl.innerHTML = msg;
    flashEl.className = "mb-4 rounded-md border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm show";
    setTimeout(function(){ flashEl.className = "mb-4 rounded-md border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm"; }, 6000);
  }

  function br4(n){ return isFinite(n) ? Number(n).toFixed(4).replace('.', ',') : '‚Äî'; }
  function br2(n){ return isFinite(n) ? Number(n).toFixed(2).replace('.', ',') : '‚Äî'; }
  function brCurrency(n){ return isFinite(n) ? Number(n).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '‚Äî'; }

  // M√°scara BRL em tempo real
  function maskBRLInput(el){
    var raw = (el.value || '').toString().replace(/\D/g,'');
    if(raw.length === 0){ el.value = ''; return; }
    var cents = parseInt(raw,10);
    if(!isFinite(cents)){ el.value=''; return; }
    var val = (cents / 100);
    el.value = 'R$ ' + val.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function parseBRLForCalc(str){
    if(str === null || str === undefined) return NaN;
    var s = String(str).trim();
    if(!s) return NaN;
    return parseFloat(s.replace(/[R$\s]/g,'').replace(/\./g,'').replace(',', '.'));
  }

  function parseGeneric(str){
    if(str === null || str === undefined) return NaN;
    var s = String(str).trim();
    if(!s) return NaN;
    return parseFloat(s.replace(/\./g,'').replace(',', '.'));
  }

  function verificarCamposObrigatorios(ids) {
    for (var i=0;i<ids.length;i++){
      var id = ids[i];
      var el = document.getElementById(id);
      if (!el || !String(el.value).trim()) {
        flash('Por favor, preencha o campo: <strong>' + id.replace(/([A-Z])/g, ' $1').trim() + '</strong>');
        return false;
      }
    }
    return true;
  }

  /* ===== Pagamento (MVP robusto) =====
     Importante:
     - N√ÉO abrimos relatorio.html antes de pagar (popups / bloqueios)
     - Salvamos o payload no localStorage
     - Redirecionamos pro mpago.la
     - O Mercado Pago volta pra relatorio.html com status=approved
  */
  var MP_LINK = "https://mpago.la/2cxW5Dn";
  var REPORT_PAGE = "./relatorio.html";
  var LS_KEY_PAYLOAD = "fap_pdf_payload_v1";
  var LS_KEY_PAID = "fap_paid_v1";
  var LS_KEY_PENDING = "fap_pending_v1";

  function saveReportPayload(){
    var payload = {
      ts: Date.now(),
      cat: (document.getElementById("cat")||{}).value || "",
      b91: (document.getElementById("b91")||{}).value || "",
      b92: (document.getElementById("b92")||{}).value || "",
      b93: (document.getElementById("b93")||{}).value || "",
      b94: (document.getElementById("b94")||{}).value || "",
      massaSalarial: (document.getElementById("massaSalarial")||{}).value || "",
      mediaVinculos: (document.getElementById("mediaVinculos")||{}).value || "",
      totalBeneficios: (document.getElementById("totalBeneficios")||{}).value || "",
      ordemFrequencia: (document.getElementById("ordemFrequencia")||{}).value || "",
      ordemGravidade: (document.getElementById("ordemGravidade")||{}).value || "",
      ordemCusto: (document.getElementById("ordemCusto")||{}).value || "",
      totalEstabelecimentos: (document.getElementById("totalEstabelecimentos")||{}).value || "",
      taxaRotatividade: (document.getElementById("taxaRotatividade")||{}).value || ""
    };
    try { localStorage.setItem(LS_KEY_PAYLOAD, JSON.stringify(payload)); } catch(e){}
    return payload;
  }

  function isPaid(){
    return localStorage.getItem(LS_KEY_PAID) === "1";
  }

  // Se por algum motivo o MP redirecionar pra ESTA p√°gina com ?status=approved, liberamos e mandamos pro relat√≥rio.
  function markPaidIfApprovedFromURL(){
    try{
      var u = new URL(location.href);
      var status = u.searchParams.get("status");
      var collection = u.searchParams.get("collection_status");
      var paid = u.searchParams.get("paid");
      if(status === "approved" || collection === "approved" || paid === "1"){
        localStorage.setItem(LS_KEY_PAID, "1");
        localStorage.removeItem(LS_KEY_PENDING);
        // manda pro relat√≥rio (onde ele vai renderizar lendo o localStorage)
        window.location.replace(REPORT_PAGE + "?paid=1");
      }
    }catch(e){}
  }

  function startPaidPdfFlow(){
    // exige dados de √≠ndice e FAP
    var obrigBase = ["cat","b91","b92","b93","b94","massaSalarial","mediaVinculos","totalBeneficios"];
    if (!verificarCamposObrigatorios(obrigBase)) return;

    var obrigFap = ["ordemFrequencia","ordemGravidade","ordemCusto","totalEstabelecimentos","taxaRotatividade"];
    if (!verificarCamposObrigatorios(obrigFap)) return;

    // se j√° pagou neste navegador, vai direto pro relat√≥rio
    if (isPaid()){
      window.location.href = REPORT_PAGE + "?paid=1";
      return;
    }

    saveReportPayload();
    try { localStorage.setItem(LS_KEY_PENDING, "1"); } catch(e){}

    // redireciona para o pagamento
    window.location.href = MP_LINK;
  }

  /* ===== C√°lculo 1: √çndices (por mil) ===== */
  function calcularIndices() {
    try{
      var obrig = ["cat","b91","b92","b93","b94","massaSalarial","mediaVinculos","totalBeneficios"];
      if (!verificarCamposObrigatorios(obrig)) return;

      var cat = parseGeneric(document.getElementById("cat").value) || 0;
      var b91 = parseGeneric(document.getElementById("b91").value) || 0;
      var b92 = parseGeneric(document.getElementById("b92").value) || 0;
      var b93 = parseGeneric(document.getElementById("b93").value) || 0;
      var b94 = parseGeneric(document.getElementById("b94").value) || 0;

      var massaSalarial   = parseBRLForCalc(document.getElementById("massaSalarial").value);
      var mediaVinculos   = parseGeneric(document.getElementById("mediaVinculos").value);
      var totalBeneficios = parseBRLForCalc(document.getElementById("totalBeneficios").value);

      if (!isFinite(massaSalarial) || massaSalarial <= 0){ flash("Massa Salarial deve ser maior que zero."); return; }
      if (!isFinite(mediaVinculos) || mediaVinculos <= 0){ flash("N√∫mero M√©dio de V√≠nculos deve ser maior que zero."); return; }

      var MULT = 1000;
      var somaEventos   = (b91 + b92 + b93 + b94 + cat);
      var somaGravidade = (b91*0.1 + b92*0.3 + b93*0.5 + b94*0.1 + cat*0.5);

      var indiceFrequencia = (somaEventos / mediaVinculos) * MULT;
      var indiceGravidade  = (somaGravidade / mediaVinculos) * MULT;
      var indiceCusto      = (totalBeneficios / massaSalarial) * MULT;

      var html = ''
        + '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">'
        +   '<div><p class="text-sm text-tax-dark-gray">√çndice de Frequ√™ncia</p><p class="text-2xl font-bold text-tax-blue">' + (isFinite(indiceFrequencia)?indiceFrequencia.toFixed(4):'‚Äî') + '</p>'
        +       '<p class="text-xs text-tax-dark-gray mt-1">Checagem: ('+somaEventos+' / '+mediaVinculos+') √ó 1000</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">√çndice de Gravidade</p><p class="text-2xl font-bold text-tax-blue">' + (isFinite(indiceGravidade)?indiceGravidade.toFixed(4):'‚Äî') + '</p>'
        +       '<p class="text-xs text-tax-dark-gray mt-1">Checagem: ('+somaGravidade.toFixed(4)+' / '+mediaVinculos+') √ó 1000</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">√çndice de Custo</p><p class="text-2xl font-bold text-tax-blue">' + (isFinite(indiceCusto)?indiceCusto.toFixed(4):'‚Äî') + '</p>'
        +       '<p class="text-xs text-tax-dark-gray mt-1">Checagem: ('+totalBeneficios+' / '+massaSalarial+') √ó 1000</p></div>'
        + '</div>';
      document.getElementById("result").innerHTML = html;

      document.getElementById("camposFap").classList.remove('hidden');
    }catch(err){
      console.error(err); flash("Erro ao calcular os √≠ndices. Revise os campos e tente novamente.");
    }
  }

  /* ===== C√°lculo 2: Percentis + FAP ===== */
  function calcularFap() {
    try{
      var obrig = ["ordemFrequencia","ordemGravidade","ordemCusto","totalEstabelecimentos","taxaRotatividade"];
      if (!verificarCamposObrigatorios(obrig)) return;

      var ordemFrequencia = parseGeneric(document.getElementById("ordemFrequencia").value) || 0;
      var ordemGravidade  = parseGeneric(document.getElementById("ordemGravidade").value) || 0;
      var ordemCusto      = parseGeneric(document.getElementById("ordemCusto").value) || 0;
      var totalEstab      = parseGeneric(document.getElementById("totalEstabelecimentos").value) || 1;
      var taxaRot         = parseGeneric(document.getElementById("taxaRotatividade").value) || 0;

      var denom = (totalEstab - 1);
      var temBasePercentil = denom > 0;

      var pFreq  = temBasePercentil ? ((ordemFrequencia - 1) / denom) * 100 : 0;
      var pGrav  = temBasePercentil ? ((ordemGravidade  - 1) / denom) * 100 : 0;
      var pCusto = temBasePercentil ? ((ordemCusto      - 1) / denom) * 100 : 0;

      var indiceComposto = ((0.5 * pGrav) + (0.35 * pFreq) + (0.15 * pCusto)) * 0.02;
      var fap = (indiceComposto <= 0.5) ? 0.5 : indiceComposto;
      if (taxaRot > 75 && fap < 1) fap = 1;

      var html = ''
        + '<div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">'
        +   '<div><p class="text-sm text-tax-dark-gray">% Frequ√™ncia</p><p class="text-2xl font-bold text-tax-blue">' + br4(pFreq) + '%</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">% Gravidade</p><p class="text-2xl font-bold text-tax-blue">' + br4(pGrav) + '%</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">% Custo</p><p class="text-2xl font-bold text-tax-blue">' + br4(pCusto) + '%</p></div>'
        +   '<div><p class="text-sm text-tax-dark-gray">FAP Calculado</p><p class="text-2xl font-bold text-tax-blue">' + br4(fap) + '</p></div>'
        + '</div>'
        + (temBasePercentil ? '' : '<p class="text-xs text-red-600 mt-2">Observa√ß√£o: N (total de estabelecimentos) ‚â§ 1. Percentis exibidos como 0% para evitar divis√£o por zero.</p>');
      document.getElementById("resultFap").innerHTML = html;
    }catch(err){
      console.error(err); flash("Erro ao calcular FAP. Revise os campos e tente novamente.");
    }
  }

  /* ===== Relat√≥rio DIRETO (mantido, apenas para debug interno) ===== */
  function abrirFormularioRelatorio() {
    try{
      flash("Relat√≥rio direto (debug) n√£o est√° ligado ao bot√£o pago. Use o fluxo pago.");
    }catch(err){
      console.error(err); flash("Erro ao gerar o relat√≥rio.");
    }
  }

  // Expor no escopo global
  window.calcularIndices = calcularIndices;
  window.calcularFap = calcularFap;
  window.abrirFormularioRelatorio = abrirFormularioRelatorio;
  window.startPaidPdfFlow = startPaidPdfFlow;

  // Garantias extras (listeners)
  document.addEventListener('DOMContentLoaded', function(){
    // se por acaso o MP voltar pro index com approved, j√° libera e manda pro relat√≥rio
    markPaidIfApprovedFromURL();

    var c  = document.getElementById('btnCalcular');
    var cf = document.getElementById('btnCalcularFap');
    var r  = document.getElementById('btnRelatorio');
    var l  = document.getElementById('btnLimpar');

    if(c)  c.addEventListener('click', calcularIndices);
    if(cf) cf.addEventListener('click', calcularFap);
    if(r)  r.addEventListener('click', startPaidPdfFlow);
    if(l)  l.addEventListener('click', function(){ location.reload(); });

    var ms = document.getElementById('massaSalarial');
    var tb = document.getElementById('totalBeneficios');
    if(ms) ms.addEventListener('blur', function(){ maskBRLInput(ms); });
    if(tb) tb.addEventListener('blur', function(){ maskBRLInput(tb); });
  });

  /* Marca aba ativa */
  document.addEventListener('DOMContentLoaded', function(){
    var tabs = document.querySelectorAll('.top-nav a');

    function norm(p){
      try { p = new URL(p, location.href).pathname; } catch(e) { p = p || ''; }
      return p.replace(/\/index\.html?$/i,'/').replace(/\/+$/,'');
    }

    var here = norm(location.pathname);
    tabs.forEach(function(a){
      var target = norm(a.getAttribute('href') || '');
      if (target && here === target) a.classList.add('is-active');
      if ((target === '' || target === '/') && (here === '' || here === '/')) a.classList.add('is-active');
    });
  });
</script>
</body>
</html>



